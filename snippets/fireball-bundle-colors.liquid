{% comment %}Fireball - Bundle Color Pickers (Dawn 15.4) - requires product tag "7-Color-Bundles"{% endcomment %}
{% assign fireball_colors = "Red|Blue|Black|White|Green|Yellow|Orange" | split: "|" %}

<div id="FireballBundleColors-{{ section_id }}" class="fireball-bundle-colors hidden" data-max="4">
  <!-- Fireball - Provide product JSON so JS can always read variants reliably -->
  <script type="application/json" id="FireballProductData-{{ section_id }}">{{ product | json }}</script>

  <fieldset class="product-form__input">
    <legend class="form__label">Choose a color for each jar in your bundle.</legend>

    {% for i in (1..4) %}
      <div class="fireball-bundle-row" data-index="{{ i }}">
        <label class="form__label" for="BundleColor{{ i }}-{{ section_id }}">Select Color #{{ i }}</label>

        <div class="select">
          <select
            class="select__select"
            id="BundleColor{{ i }}-{{ section_id }}"
            name="properties[Select Color #{{ i }}]"
            autocomplete="off"
          >
            <option value="" selected>Please select</option>
            {% for c in fireball_colors %}
              <option value="{{ c }}">{{ c }}</option>
            {% endfor %}
          </select>
          <span class="icon-caret">
            {{- 'icon-caret.svg' | inline_asset_content -}}
          </span>
        </div>
      </div>
    {% endfor %}
  </fieldset>
</div>

<style>
  /* Fireball - keep it native Dawn */
  #FireballBundleColors-{{ section_id }}.hidden { display: none; }

  /* spacing to match Dawn fields */
  #FireballBundleColors-{{ section_id }} .fireball-bundle-row { 
    margin: 0.5rem 0 1rem; 
  }
  #FireballBundleColors-{{ section_id }} .form__label { 
    margin-bottom: .25rem; 
  }

  /* prevent select from getting squashed in grid/containers */
  #FireballBundleColors-{{ section_id }} .select { 
    width: 100%; 
  }
  #FireballBundleColors-{{ section_id }} .select__select { 
    width: 100%; 
    min-width: 0; 
  }
</style>

<script>
/* Fireball DEBUG â€“ PDP + Featured Product (Dawn 15.4)
   - Wider 2/4 detection: "2 Pack", "2-Pack", "2pk", "Set of 2", "Bundle 4", plain "2"/"4" when option name implies size
   - Stronger form targeting for home Featured Product
   - Console logs + on-page HUD with state
*/
(function () {
  const sectionId = "{{ section_id }}";
  const wrapper = document.getElementById(`FireballBundleColors-${sectionId}`);
  if (!wrapper) { console.warn('[Fireball] wrapper missing', { sectionId }); return; }

  // --- Find the form for THIS section (works on homepage) ---
  const productFormEl = document.querySelector(`product-form[data-section-id="${sectionId}"]`);
  const form = productFormEl ? productFormEl.querySelector('form[action*="/cart/add"]') : wrapper.closest('form[action*="/cart/add"]');
  if (!form) { 
    console.error('[Fireball] product form NOT found', { sectionId, productFormEl, wrapper });
    hud('form NOT found');
    return; 
  }

  // --- Small on-page HUD for quick state ---
  function hud(text){
    let el = wrapper.querySelector('[data-fireball-hud]');
    if (!el) {
      el = document.createElement('div');
      el.setAttribute('data-fireball-hud','');
      el.style.cssText = 'margin-top:6px;font:12px/1.3 system-ui,Arial;padding:6px 8px;border:1px solid #ddd;border-radius:6px;background:#f7f7f7;color:#333';
      wrapper.appendChild(el);
    }
    el.textContent = 'ðŸ”¥ DEBUG â€¢ ' + text;
  }

  // Allow native required to help
  try { form.removeAttribute('novalidate'); } catch (e) {}

  // ---- Data helpers (guarded) ----
  function getProductData() {
    try {
      const el = document.getElementById(`FireballProductData-${sectionId}`);
      const data = el ? JSON.parse(el.textContent) : null;
      return (data && typeof data === 'object') ? data : null;
    } catch (e) { return null; }
  }
  const productData = getProductData();

  function currentVariant() {
    const idInput = form.querySelector('input[name="id"]');
    const vid = idInput ? idInput.value : null;
    if (!productData || !Array.isArray(productData.variants) || !vid) return null;
    try {
      return productData.variants.find && productData.variants.find(v => String(v.id) === String(vid)) || null;
    } catch (e) { return null; }
  }

  // ---- Pack detection (WIDE) ----
  // catches: 2 Pack / 2-Pack / 2pk / Set of 2 / Bundle of 4 / x4 / plain "2"/"4" if option label implies size
  const rx2 = /\b(2\s*[- ]?pack|2\s*pk|set\s*of\s*2|bundle\s*(of\s*)?2|x\s*2|\(2\)|\b2\b)\b/i;
  const rx4 = /\b(4\s*[- ]?pack|4\s*pk|set\s*of\s*4|bundle\s*(of\s*)?4|x\s*4|\(4\)|\b4\b)\b/i;
  const rxPackishName = /(pack|size|count|bundle|set|quantity|qty)/i;

  function matchPackFromString(s) {
    if (!s) return 0;
    if (rx4.test(s)) return 4;
    if (rx2.test(s)) return 2;
    return 0;
  }

  function packFromVariant(v) {
    if (!v) return 0;
    const parts = [];
    if (v.title) parts.push(v.title);
    if (Array.isArray(v.options)) parts.push(...v.options);
    return matchPackFromString(parts.join(' | '));
  }

  function packFromControls() {
    let buf = [];

    // 1) Collect ALL visible option texts/values
    form.querySelectorAll('[name^="options"]').forEach(el => {
      const name = (el.getAttribute('name') || '').toLowerCase();
      const labelEl = el.id ? form.querySelector(`label[for="${el.id}"]`) : null;
      const labelText = labelEl ? labelEl.textContent.trim() : '';
      if ((el.type === 'radio' || el.type === 'checkbox')) {
        if (el.checked) buf.push(labelText || el.value);
      } else if (el.tagName === 'SELECT') {
        const opt = el.options[el.selectedIndex];
        if (opt) buf.push((opt.text || opt.value));
        // also consider the select label if it implies pack
        if (rxPackishName.test(labelText)) buf.push(labelText);
        // some themes put field title in aria-label
        const aria = el.getAttribute('aria-label');
        if (aria) buf.push(aria);
      }
    });

    // 2) Additionally scan any variant pills/buttons (button picker)
    form.querySelectorAll('.variant-picker, .product-form__input, fieldset').forEach(fs => {
      buf.push(fs.getAttribute('data-option-name') || '');
      buf.push(fs.querySelector('legend')?.textContent || '');
      fs.querySelectorAll('input[type="radio"]:checked + label, .swatch-input__label--variant, .product-form__input input[type="radio"]:checked + label').forEach(lab => {
        buf.push(lab.textContent || '');
      });
    });

    // 3) Quick explicit checks
    const joined = buf.join(' | ');
    const m = matchPackFromString(joined);
    return m;
  }

  function calcPackCount() {
    // a) try variant JSON
    const v = currentVariant();
    const a = packFromVariant(v);
    if (a) return a;

    // b) try DOM controls
    const b = packFromControls();
    if (b) return b;

    // c) explicit short-circuit search in selected options
    if (form.querySelector('input[type="radio"][value*="4" i]:checked, select option:checked[value*="4" i]')) return 4;
    if (form.querySelector('input[type="radio"][value*="2" i]:checked, select option:checked[value*="2" i]')) return 2;

    return 0;
  }

  // ---- UI + validation ----
  function selectionsComplete() {
    if (wrapper.classList.contains('hidden')) return true;
    const rows = wrapper.querySelectorAll('.fireball-bundle-row');
    for (const row of rows) {
      if (row.style.display === 'none') continue;
      const sel = row.querySelector('select');
      if (!sel.value) return false;
    }
    return true;
  }

  function setButtonsEnabled(enabled) {
    const submitBtn = form.querySelector('[type="submit"][name="add"]');
    if (submitBtn) submitBtn.disabled = !enabled;
    const payContainer = form.querySelector('.shopify-payment-button');
    if (payContainer) {
      payContainer.style.pointerEvents = enabled ? '' : 'none';
      payContainer.style.opacity = enabled ? '' : '0.5';
      const innerBtn = payContainer.querySelector('button');
      if (innerBtn) innerBtn.disabled = !enabled;
    }
  }

  function showRows(count) {
    const rows = wrapper.querySelectorAll('.fireball-bundle-row');
    rows.forEach((row, idx) => {
      const sel = row.querySelector('select');
      if (idx + 1 <= count) {
        row.style.display = '';
        sel.setAttribute('required', 'required');
      } else {
        row.style.display = 'none';
        sel.removeAttribute('required');
        sel.value = '';
      }
    });
    wrapper.classList.toggle('hidden', count === 0);
    setButtonsEnabled(selectionsComplete());
  }

  function refresh(reason) {
    const pack = calcPackCount();
    showRows(pack);
    const idInput = form.querySelector('input[name="id"]');
    const vid = idInput ? idInput.value : '(no id)';
    console.log('[Fireball] refresh', { page: location.pathname, sectionId, pack, vid, formFound: !!form });
    hud(`form:${!!form} â€¢ pack:${pack} â€¢ variant:${vid} â€¢ complete:${selectionsComplete()}`);
    // expose state for quick copy
    window.FireballState = { sectionId, pack, vid, formFound: !!form };
  }

  // Prevent submit when incomplete (stop theme handler too)
  form.addEventListener('submit', function (ev) {
    if (!selectionsComplete()) {
      ev.preventDefault();
      ev.stopImmediatePropagation();
      alert('Please choose a color for each jar in your bundle.');
      console.warn('[Fireball] blocked submit â€“ selections incomplete', { sectionId });
      return false;
    }
  });

  document.addEventListener('variant:change', e => { if (form.contains(e.target)) refresh('variant:change'); });
  form.addEventListener('change', () => refresh('form:change'));

  const idInput = form.querySelector('input[name="id"]');
  if (idInput && 'MutationObserver' in window) {
    new MutationObserver(() => refresh('id:mutation')).observe(idInput, { attributes: true, attributeFilter: ['value'] });
  }

  // Initial + microtask tick
  refresh('init');
  setTimeout(() => refresh('post-mount'), 0);
})();
</script>
