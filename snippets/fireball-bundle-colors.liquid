{% comment %}Fireball - Bundle Color Pickers (Dawn 15.4) - requires tag "7-Color-Bundles"{% endcomment %}
{% assign fireball_colors = "Red|Blue|Black|White|Green|Yellow|Orange" | split: "|" %}

<div id="FireballBundleColors-{{ section_id }}" class="fireball-bundle-colors hidden" data-max="4">
  <!-- Fireball - Provide product JSON so JS can always read variants reliably -->
  <script type="application/json" id="FireballProductData-{{ section_id }}">{{ product | json }}</script>

  <fieldset class="fireball-bundle-colors__fieldset">
    <legend class="fireball-bundle-colors__legend">Choose a color for each jar in your bundle.</legend>

    {% for i in (1..4) %}
      <div class="fireball-bundle-colors__row" data-index="{{ i }}">
        <label class="fireball-bundle-colors__label" for="BundleColor{{ i }}-{{ section_id }}">
          Color Selection #{{ i }}
        </label>
        <select
          class="fireball-bundle-colors__select"
          id="BundleColor{{ i }}-{{ section_id }}"
          name="properties[Color Selection #{{ i }}]"
          autocomplete="off"
        >
          <option value="" selected>Please select</option>
          {% for c in fireball_colors %}
            <option value="{{ c }}">{{ c }}</option>
          {% endfor %}
        </select>
      </div>
    {% endfor %}
  </fieldset>
</div>

<style>
  /* Fireball - polished, Dawn-friendly look */
  #FireballBundleColors-{{ section_id }}.hidden { display: none; }

  #FireballBundleColors-{{ section_id }} .fireball-bundle-colors__fieldset {
    margin: 1rem 0 0;
    padding: .85rem;
    border: 1px solid rgba(0,0,0,.10);
    border-radius: .75rem;
    background: rgba(0,0,0,.02);
  }

  #FireballBundleColors-{{ section_id }} .fireball-bundle-colors__legend {
    font-size: 1rem;          /* matches Quantity label size */
    font-weight: 600;
    margin: 0 0 .75rem 0;
    letter-spacing: .01em;
  }

  #FireballBundleColors-{{ section_id }} .fireball-bundle-colors__row {
    display: grid;
    grid-template-columns: 1fr;
    gap: .5rem;
    align-items: center;
    padding: .35rem 0;
  }

  /* two-column on desktop so it feels tighter & aligned */
  @media (min-width: 750px) {
    #FireballBundleColors-{{ section_id }} .fireball-bundle-colors__row {
      grid-template-columns: 220px 1fr;
    }
  }

  #FireballBundleColors-{{ section_id }} .fireball-bundle-colors__label {
    font-weight: 600;
    color: rgba(0,0,0,.85);
  }

  #FireballBundleColors-{{ section_id }} .fireball-bundle-colors__select {
    width: 100%;
    min-height: 44px;                 /* same feel as Dawn inputs */
    padding: .55rem .75rem;
    border: 1px solid rgba(0,0,0,.18);
    border-radius: .5rem;
    background: #fff;
  }

  #FireballBundleColors-{{ section_id }} .fireball-bundle-colors__select:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(0,0,0,.08);
    border-color: rgba(0,0,0,.35);
  }
</style>

<script>
/* Fireball - robust logic for 2-Pack / 4-Pack visibility & validation */
(function() {
  const sectionId = "{{ section_id }}";
  const wrapper = document.getElementById(`FireballBundleColors-${sectionId}`);
  if (!wrapper) return;

  const form = wrapper.closest('form[action*="/cart/add"]');
  if (!form) { console.warn('Fireball Bundle: product form not found'); return; }

  function getProductData() {
    try {
      const el = document.getElementById(`FireballProductData-${sectionId}`);
      return el ? JSON.parse(el.textContent) : null;
    } catch (e) { return null; }
  }
  const productData = getProductData();

  function currentVariant() {
    const idInput = form.querySelector('input[name="id"]');
    const vid = idInput ? idInput.value : null;
    if (!productData || !vid) return null;
    return productData.variants.find(v => String(v.id) === String(vid)) || null;
  }

  // Accept "2 Pack", "2-Pack", "2pk" (same for 4)
  function getPackCount(variant) {
    const parts = [];
    if (variant && variant.title) parts.push(variant.title);
    if (variant && Array.isArray(variant.options)) parts.push(...variant.options);
    const s = parts.join(' | ');
    if (/(^|\b)(4\s*[- ]?pack|4\s*pk)\b/i.test(s)) return 4;
    if (/(^|\b)(2\s*[- ]?pack|2\s*pk)\b/i.test(s)) return 2;
    return 0;
  }

  function showRows(count) {
    const rows = wrapper.querySelectorAll('.fireball-bundle-colors__row');
    rows.forEach((row, idx) => {
      const sel = row.querySelector('select');
      if (idx + 1 <= count) {
        row.style.display = '';
        sel.setAttribute('required', 'required');
      } else {
        row.style.display = 'none';
        sel.removeAttribute('required');
        sel.value = '';
      }
    });
    wrapper.classList.toggle('hidden', count === 0);
  }

  function refresh() {
    const v = currentVariant();
    showRows(getPackCount(v));
  }

  document.addEventListener('variant:change', refresh);
  form.addEventListener('change', function(e) {
    if ((e.target.name || '').startsWith('options') || e.target.classList.contains('product-variant-id')) refresh();
  });
  const idInput = form.querySelector('input.product-variant-id[name="id"]') || form.querySelector('input[name="id"]');
  if (idInput && 'MutationObserver' in window) {
    new MutationObserver(refresh).observe(idInput, { attributes: true, attributeFilter: ['value'] });
  }

  form.addEventListener('submit', function(ev) {
    if (wrapper.classList.contains('hidden')) return;
    const selects = wrapper.querySelectorAll('.fireball-bundle-colors__row select');
    for (const sel of selects) {
      if (sel.offsetParent !== null && sel.hasAttribute('required') && !sel.value) {
        ev.preventDefault();
        sel.focus();
        alert('Please choose a color for each jar in your bundle.');
        return false;
      }
    }
  });

  refresh();
})();
</script>
